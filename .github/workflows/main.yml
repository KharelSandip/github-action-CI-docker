name: Ci Pipeline Docker Project

# Trigger CI on pushes and pull requests targeting the main branch
on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

# Restrict workflow permissions
permissions:
  contents: read

jobs:
  build-and-scan:
    name: Build, Test, and Scan
    runs-on: ubuntu-latest

    steps:
      # Checking the repository source code into the runner workspace
      - name: Checkout code
        uses: actions/checkout@v4

      # Install Node.js and enable npm dependency caching
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      # Install dependencies using lockfile for reproducible builds
      - name: Install dependencies
        run: npm ci

      # Execute tests
      - name: Run tests 
        run: npm test --if-present

      # Build application Docker image from Dockerfile
      - name: Build Docker image
        run: docker build -t docker-project-1:ci .

       # Scan container image for vulnerabilities
      - name: Trivy image scan 
        uses: aquasecurity/trivy-action@0.28.0
        with:
          image-ref: docker-project-1:ci
          format: table
          output: ./trivy-report.txt
          severity: HIGH,CRITICAL
          exit-code: "0"
          ignore-unfixed: true

      - name: Fail if HIGH/CRITICAL vulnerabilities found
        uses: aquasecurity/trivy-action@0.28.0
        with:
          image-ref: docker-project-1:ci
          format: table
          severity: HIGH,CRITICAL
          ignore-unfixed: true
          exit-code: "1"

      # Upload vulnerability scan results for audit and review
      - name: Upload Trivy scan report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: trivy-vulnerability-report
          path: ./trivy-report.txt
          retention-days: 90

      # Display built image metadata for verifications
      - name: Display image information
        if: success()
        run: docker images docker-project-1:ci
